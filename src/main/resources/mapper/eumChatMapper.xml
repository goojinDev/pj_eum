<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.eum.pj_eum.mapper.eumChatMapper">

    <!-- 이음 채팅 목록 조회 -->
    <select id="selectEumChatList" resultType="com.eum.pj_eum.dto.eumChatListResponse" parameterType="long">
        SELECT
            ecl.eume_chat_id AS eumeChatId,
            ecl.user_id AS userId,
            ecl.chat_status AS chatStatus,
            ecl.reg_date AS regDate,
            ecl.upd_date AS updDate,
            (
                SELECT ecc.message_content
                FROM eume_chat_content ecc
                WHERE ecc.eume_chat_id = ecl.eume_chat_id
                  AND ecc.message_type = 'AI'
                ORDER BY ecc.reg_date ASC
                                LIMIT 1
            ) AS firstMessagePreview
        FROM eume_chat_list ecl
        WHERE ecl.user_id = #{userId}
          AND ecl.chat_status = 'ACTIVE'
        ORDER BY ecl.upd_date DESC, ecl.reg_date DESC
    </select>

    <!-- 새 이음 채팅방 생성 (AUTO_INCREMENT 적용) -->
    <insert id="insertEumChat" parameterType="map" useGeneratedKeys="true" keyProperty="eumeChatId">
        INSERT INTO eume_chat_list (
            user_id,
            chat_status
        ) VALUES (
                     #{userId},
                     'ACTIVE'
                 )
    </insert>

    <!-- 이음 채팅 메시지 저장 (AUTO_INCREMENT 적용) -->
    <insert id="insertEumMessage" parameterType="com.eum.pj_eum.dto.eumMessageSaveRequest"
            useGeneratedKeys="true" keyProperty="eumeMessageId">
        INSERT INTO eume_chat_content (
            eume_chat_id,
            user_id,
            message_type,
            message_content
        ) VALUES (
                     #{eumeChatId},
                     #{userId},
                     #{messageType},
                     #{messageContent}
                 )
    </insert>

    <!-- 특정 이음 채팅방의 메시지 목록 조회 -->
    <select id="selectEumMessages" resultType="com.eum.pj_eum.dto.eumChatMessageResponse" parameterType="long">
        SELECT
            eume_message_id AS eumeMessageId,
            eume_chat_id AS eumeChatId,
            user_id AS userId,
            message_type AS messageType,
            message_content AS messageContent,
            reg_date AS regDate
        FROM eume_chat_content
        WHERE eume_chat_id = #{eumeChatId}
        ORDER BY reg_date ASC
    </select>

    <!-- 감정 점수 저장 (AUTO_INCREMENT 적용) -->
    <insert id="insertEmotionScore" parameterType="com.eum.pj_eum.dto.emotionScoreSaveRequest"
            useGeneratedKeys="true" keyProperty="emotionId">
        INSERT INTO user_emotion (
            user_id,
            depression_score,
            anxiety_score,
            stress_score,
            emotion_score,
            keywords,
            model_version
        ) VALUES (
                     #{userId},
                     #{depressionScore},
                     #{anxietyScore},
                     #{stressScore},
                     #{emotionScore},
                     #{keywords},
                     #{modelVersion}
                 )
    </insert>

    <!-- 이음 채팅 상태 변경 -->
    <update id="updateEumChatStatus">
        UPDATE eume_chat_list
        SET chat_status = #{chatStatus},
            upd_date = CURRENT_TIMESTAMP
        WHERE eume_chat_id = #{eumeChatId}
    </update>

    <!-- 사용자의 최근 감정 분석 결과 조회 -->
    <select id="selectRecentEmotion" resultType="com.eum.pj_eum.dto.emotionResponse" parameterType="long">
        SELECT
            emotion_id AS emotionId,
            user_id AS userId,
            depression_score AS depressionScore,
            anxiety_score AS anxietyScore,
            stress_score AS stressScore,
            emotion_score AS emotionScore,
            keywords,
            analysis_date AS analysisDate,
            model_version AS modelVersion
        FROM user_emotion
        WHERE user_id = #{userId}
        ORDER BY analysis_date DESC
            LIMIT 1
    </select>

</mapper>