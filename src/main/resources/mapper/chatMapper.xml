<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.eum.pj_eum.mapper.chatMapper">

    <!-- 일반 채팅 목록 조회 -->
    <select id="selectChatList" resultType="com.eum.pj_eum.dto.chatListResponse" parameterType="long">
        SELECT
            chat_room_id AS chatRoomId,
            user_id AS userId,
            room_title AS roomTitle,
            room_status AS roomStatus,
            reg_date AS regDate,
            upd_date AS updDate
        FROM user_chat_list
        WHERE user_id = #{userId}
          AND room_status = 'ACTIVE'
        ORDER BY upd_date DESC, reg_date DESC
    </select>

    <!-- 새 채팅방 생성 (AUTO_INCREMENT 적용) -->
    <insert id="insertChatRoom" parameterType="map" useGeneratedKeys="true" keyProperty="chatRoomId">
        INSERT INTO user_chat_list (
            user_id,
            room_status
        ) VALUES (
                     #{userId},
                     'ACTIVE'
                 )
    </insert>

    <!-- 채팅 메시지 저장 (AUTO_INCREMENT 적용) -->
    <insert id="insertChatMessage" parameterType="com.eum.pj_eum.dto.chatMessageSaveRequest"
            useGeneratedKeys="true" keyProperty="messageId">
        INSERT INTO user_chat_content (
            chat_room_id,
            user_id,
            message_type,
            message_content
        ) VALUES (
                     #{chatRoomId},
                     #{userId},
                     #{messageType},
                     #{messageContent}
                 )
    </insert>

    <!-- 채팅방 제목 업데이트 -->
    <update id="updateRoomTitle">
        UPDATE user_chat_list
        SET room_title = #{roomTitle},
            upd_date = CURRENT_TIMESTAMP
        WHERE chat_room_id = #{chatRoomId}
    </update>

    <!-- 채팅방 상태 변경 -->
    <update id="updateChatRoomStatus">
        UPDATE user_chat_list
        SET room_status = #{roomStatus},
            upd_date = CURRENT_TIMESTAMP
        WHERE chat_room_id = #{chatRoomId}
    </update>

    <!-- 특정 채팅방의 메시지 목록 조회 -->
    <select id="selectChatMessages" resultType="com.eum.pj_eum.dto.chatMessageResponse" parameterType="long">
        SELECT
            message_id AS messageId,
            chat_room_id AS chatRoomId,
            user_id AS userId,
            message_type AS messageType,
            message_content AS messageContent,
            reg_date AS regDate
        FROM user_chat_content
        WHERE chat_room_id = #{chatRoomId}
        ORDER BY reg_date ASC
    </select>

</mapper>