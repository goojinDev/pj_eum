<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.eum.pj_eum.mapper.chatMapper">

    <!-- 일반 채팅 목록 조회 -->
    <select id="selectChatList" resultType="com.eum.pj_eum.dto.chatListResponse">
        SELECT
            chat_room_id AS chatRoomId,
            user_id AS userId,
            room_title AS roomTitle,
            room_status AS roomStatus,
            last_message AS lastMessage,
            last_message_date AS lastMessageDate,
            message_count AS messageCount
        FROM pj_user_chat_list
        WHERE user_id = #{userId}
          AND room_status = 'ACTIVE'
        ORDER BY CASE WHEN last_message_date IS NULL THEN 1 ELSE 0 END,
                 last_message_date DESC,
                 reg_date DESC
    </select>

    <!-- 새 채팅방 생성 -->
    <insert id="insertChatRoom">
        INSERT INTO pj_user_chat_list (
            chat_room_id,
            user_id,
            room_status,
            message_count,
            reg_date,
            upd_date
        ) VALUES (
                     #{chatRoomId},
                     #{userId},
                     'ACTIVE',
                     0,
                     CURRENT_TIMESTAMP,
                     CURRENT_TIMESTAMP
                 )
    </insert>

    <!-- 현재 채팅방의 최대 메시지 순서 조회 -->
    <select id="selectMaxMessageSeq" resultType="Integer">
        SELECT MAX(message_seq)
        FROM pj_user_chat_content
        WHERE chat_room_id = #{chatRoomId}
          AND is_deleted = 'N'
    </select>

    <!-- 채팅 메시지 저장 -->
    <insert id="insertChatMessage">
        INSERT INTO pj_user_chat_content (
            message_id,
            chat_room_id,
            user_id,
            message_type,
            message_content,
            message_seq,
            is_deleted,
            reg_date
        ) VALUES (
                     #{messageId},
                     #{chatRoomId},
                     #{userId},
                     #{messageType},
                     #{messageContent},
                     #{messageSeq},
                     'N',
                     CURRENT_TIMESTAMP
                 )
    </insert>

    <!-- 채팅방 정보 업데이트 -->
    <update id="updateChatRoomInfo">
        UPDATE pj_user_chat_list
        SET last_message = #{lastMessage},
            last_message_date = CURRENT_TIMESTAMP,
            message_count = (
                SELECT COUNT(*)
                FROM pj_user_chat_content
                WHERE chat_room_id = #{chatRoomId}
                  AND is_deleted = 'N'
            ),
            upd_date = CURRENT_TIMESTAMP
        WHERE chat_room_id = #{chatRoomId}
    </update>

    <!-- 채팅방 제목 수정 -->
    <update id="updateRoomTitle">
        UPDATE pj_user_chat_list
        SET room_title = #{roomTitle},
            upd_date = CURRENT_TIMESTAMP
        WHERE chat_room_id = #{chatRoomId}
    </update>

    <!-- 채팅방 상태 변경 -->
    <update id="updateChatRoomStatus">
        UPDATE pj_user_chat_list
        SET room_status = #{roomStatus},
            upd_date = CURRENT_TIMESTAMP
        WHERE chat_room_id = #{chatRoomId}
    </update>

</mapper>